Name: RunAllTests
Compute:
  Type: EC2
  Fleet: Linux.x86-64.Large
SchemaVersion: "1.0"
Triggers:
  - Type: Push
    Branches:
      - main
Actions:
  InstallDependencies:
    Identifier: aws/build@v1.0.0
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: rpt
    Configuration:
      Steps:
        - Run: npm ci --cache .npm
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Environment:
      Name: development
    Timeout: 60
    Caching:
      FileCaching:
        npm-cache:
          Path: .npm
  RunUnitTests:
    Actions:
      RunCdkTests:
        Identifier: aws/managed-test@v1.0.0
        Inputs:
          Sources:
            - WorkflowSource
        Outputs:
          AutoDiscoverReports:
            Enabled: true
            ReportNamePrefix: rpt
        Configuration:
          Steps:
            - Run: npm ci --cache .npm
            - Run: npm run test:cdk:ci
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_x86_64:2024_03
        Environment:
          Name: development
        Timeout: 60
        Caching:
          FileCaching:
            npm-cache:
              Path: .npm
      RunLambdaTests:
        Identifier: aws/managed-test@v1.0.0
        Inputs:
          Sources:
            - WorkflowSource
        Outputs:
          AutoDiscoverReports:
            Enabled: true
            ReportNamePrefix: rpt
        Configuration:
          Steps:
            - Run: python --version
            - Run: python -m pip install -U pip setuptools tox
            - Run: npm run test:app:ci
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_x86_64:2024_03
        Environment:
          Name: development
        Timeout: 60
    DependsOn:
      - InstallDependencies
  RunCdkBootstrap:
    Identifier: aws/build@v1.0.0
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: npm ci --cache .npm
        - Run: npx --cache .npm cdk bootstrap
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Environment:
      Name: development
    Timeout: 60
    DependsOn:
      - InstallDependencies
    Caching:
      FileCaching:
        npm-cache:
          Path: .npm
  Deploy:
    Actions:
      DeploySolution:
        Identifier: aws/build@v1.0.0
        Inputs:
          Sources:
            - WorkflowSource
        Configuration:
          Steps:
            - Run: npm ci --cache .npm
            - Run: npx --cache .npm cdk deploy instance-scheduler-on-aws --context
                stackName=instance-scheduler-on-aws-test --parameters
                SchedulerFrequency=1 --parameters Namespace=e2etesting
                --parameters ScheduledServices=Both --parameters
                EnableSSMMaintenanceWindows=Yes --parameters Trace=Yes
                --require-approval never
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_x86_64:2024_03
        Environment:
          Name: development
        Timeout: 60
        Caching:
          FileCaching:
            npm-cache:
              Path: .npm
      DeployTestResources:
        Identifier: aws/build@v1.0.0
        Inputs:
          Sources:
            - WorkflowSource
        Configuration:
          Steps:
            - Run: npm ci --cache .npm
            - Run: npx --cache .npm cdk deploy instance-scheduler-on-aws-end-to-end-testing-resources
                --require-approval never
          Container:
            Registry: CODECATALYST
            Image: CodeCatalystLinux_x86_64:2024_03
        Environment:
          Name: development
        Timeout: 60
        Caching:
          FileCaching:
            npm-cache:
              Path: .npm
    DependsOn:
      - RunUnitTests
      - RunCdkBootstrap
  RunE2ETests:
    Identifier: aws/managed-test@v1.0.0
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: rpt
    Configuration:
      Steps:
        - Run: npm ci --cache .npm
        - Run: npm run e2e-tests
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Environment:
      Name: development
    DependsOn:
      - Deploy
    Timeout: 60
    Caching:
      FileCaching:
        npm-cache:
          Path: .npm
